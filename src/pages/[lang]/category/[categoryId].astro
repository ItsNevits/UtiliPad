---
export const prerender = false;

import MainLayout from "../../../Layouts/MainLayout.astro";
import Hero from "@/components/shared/Hero.astro";
import Tools from "@/components/shared/Tools.astro";
import BreadCrumbs from "@/components/shared/BreadCrumbs.astro";

// Componentes de herramientas
import JsonFormatter from "@/features/tools/json-formatter/JsonFormatter.astro";
import PasswordGenerator from "@/features/tools/password-generator/PasswordGenerator.astro";
import TextAnalyzer from "@/features/tools/text-analyzer/TextAnalyzer.astro";
import QrGenerator from "@/features/tools/qr-generator/QrGenerator.astro";
import ImageCompressor from "@/features/tools/image-compressor/ImageCompressor.astro";
import ImageConverter from "@/features/tools/image-converter/ImageConverter.astro";
import FileConverter from "@/features/tools/file-converter/FileConverter.astro";
import ZipCompressor from "@/features/tools/zip-compressor/ZipCompressor.astro";

import { TOOLS_CATEGORIES, getToolById } from "@/config/tools.config";
import type { Language } from "@/types/language.type";
import { getTranslatedCategories } from "@/utils/tools";

// Obtener los parámetros de la URL
const { categoryId } = Astro.params;
// Obtener idioma
const lang = Astro.params.lang as Language;

// Mapeo de componentes
const COMPONENT_MAP = {
  // Files Components
  ZipCompressor: ZipCompressor,
  FileConverter: FileConverter,

  // Text Components
  TextAnalyzer: TextAnalyzer,
  JsonFormatter: JsonFormatter,
  QrGenerator: QrGenerator,
  PasswordGenerator: PasswordGenerator,

  // Images Components
  ImageConverter: ImageConverter,
  ImageCompressor: ImageCompressor,
};

// Configurar traducciones
const translatedCategories = getTranslatedCategories(lang);

// Obtener el parámetro de query 'tool' si existe
const toolId = Astro.url.searchParams.get("tool");

// Buscar la categoría correspondiente (original para lógica)
const originalCategory = TOOLS_CATEGORIES.find((cat) => cat.id === categoryId);

// Si no existe la categoría, retornar 404
if (!originalCategory) {
  return Astro.redirect("/404");
}

// Obtener la categoría traducida
const category =
  translatedCategories.find((cat: any) => cat.id === categoryId) ||
  originalCategory;

import { getTranslation } from "@/i18n/index";

// Obtener traducciones de herramientas
const getTranslatedToolName = (toolId: string, tool?: any) => {
  return (
    getTranslation(lang, `tools.items.${toolId}.name`) || tool?.name || toolId
  );
};

const getTranslatedToolDescription = (toolId: string, tool?: any) => {
  return (
    getTranslation(lang, `tools.items.${toolId}.description`) ||
    tool?.description ||
    ""
  );
};

// Si hay un toolId específico, buscar la herramienta
let selectedTool = null;
if (toolId) {
  selectedTool = getToolById(toolId);
  // Verificar que la herramienta pertenezca a esta categoría
  if (
    !selectedTool ||
    !originalCategory.tools.find((tool) => tool.id === toolId)
  ) {
    return Astro.redirect("/404");
  }
}

// Configurar el contenido del hero basado en si hay una herramienta específica
const currentHero = selectedTool
  ? {
      title: getTranslatedToolName(selectedTool.id, selectedTool),
      description: getTranslatedToolDescription(selectedTool.id, selectedTool),
    }
  : {
      title: category.title,
      description: category.description,
    };

// Obtener el componente correspondiente si existe
let ToolComponent = null;
if (
  selectedTool?.component &&
  COMPONENT_MAP[selectedTool.component as keyof typeof COMPONENT_MAP]
) {
  ToolComponent =
    COMPONENT_MAP[selectedTool.component as keyof typeof COMPONENT_MAP];
}

// Generar breadcrumbs
const breadcrumbs = [];
if (selectedTool) {
  // Para herramienta específica: Inicio > Categoría > Herramienta
  const translatedToolName = getTranslatedToolName(
    selectedTool.id,
    selectedTool
  );
  breadcrumbs.push(
    {
      href: `/${lang}/category/${categoryId}`,
      name: category.name,
      isActive: false,
    },
    { href: selectedTool.href, name: translatedToolName, isActive: true }
  );
} else {
  // Para categoría: Inicio > Categoría
  breadcrumbs.push({
    href: `/${lang}/category/${categoryId}`,
    name: category.name,
    isActive: true,
  });
}

// SEO title y description con reemplazo de placeholders
const titleSeo = selectedTool
  ? getTranslation(lang, "seo.pages.tool.title")?.replace(
      "{tool}",
      getTranslatedToolName(selectedTool.id, selectedTool)
    )
  : getTranslation(lang, "seo.pages.category.title")?.replace(
      "{category}",
      category.name
    );
const descriptionSeo = selectedTool
  ? getTranslation(lang, "seo.pages.tool.description")?.replace(
      "{tool}",
      getTranslatedToolName(selectedTool.id, selectedTool)
    )
  : getTranslation(lang, "seo.pages.category.description")?.replace(
      "{category}",
      category.name
    );
---

<MainLayout title={titleSeo} description={descriptionSeo}>
  <BreadCrumbs links={breadcrumbs} />

  <!-- Hero -->
  <Hero title={currentHero.title} description={currentHero.description} />

  {
    selectedTool ? (
      <div class="py-5 select-none">
        {ToolComponent ? (
          <ToolComponent />
        ) : (
          <div class="bg-neutral-900/40 rounded-2xl border border-neutral-800 p-6">
            <span>{getTranslation(lang, "tools.messages.notImplemented")}</span>
          </div>
        )}

        <div class="mt-8">
          <h3 class="text-lg font-semibold mb-4">
            {lang === "es"
              ? `${getTranslation(lang, "tools.messages.otherToolsPrefix")} ${category.name.toLowerCase()}`
              : `${getTranslation(lang, "tools.messages.otherToolsPrefix")} ${category.name.toLowerCase()} ${getTranslation(lang, "tools.messages.otherToolsSuffix")}`}
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {originalCategory.tools
              .filter((tool) => tool.id !== selectedTool.id && tool.isAvailable)
              .map((tool) => (
                <a
                  href={`/${lang}/tools/${tool.id}`}
                  class="block p-4 bg-neutral-900/40 rounded-xl border border-neutral-800 hover:border-emerald-600/60 transition-colors"
                >
                  <h4 class="font-medium mb-1">
                    {getTranslatedToolName(tool.id, tool)}
                  </h4>
                  <p class="text-sm text-neutral-400">
                    {getTranslatedToolDescription(tool.id, tool)}
                  </p>
                </a>
              ))}
            {originalCategory.tools.filter(
              (tool) => tool.id !== selectedTool.id && tool.isAvailable
            ).length === 0 && (
              <p class="text-sm text-neutral-400 col-span-full">
                {getTranslation(lang, "tools.messages.noMoreTools")}
              </p>
            )}
          </div>
        </div>
      </div>
    ) : (
      <Tools categoryId={categoryId} />
    )
  }
</MainLayout>
