---
import { Picture } from "astro:assets";
import type { Language } from "@/types/language.type";
import { getTranslatedTools } from "@/utils/tools";
import { getTranslation } from "@/i18n/index";
import { actions } from "astro:actions";
import ImageEditor from "@/assets/images/ImageEditor.png";

const lang = (Astro.params.lang as Language) || "es";

// Obtener título y descripción de las traducciones
const title = getTranslation(lang, "components.featuredTools.title");
const description = getTranslation(lang, "components.featuredTools.description");

// Obtener las 3 herramientas más utilizadas
const { data } = await Astro.callAction(actions.mostUsedTool, {});

let featuredToolIds: string[] = ["json-formatter", "image-compress", "qr-generator"]; // Default

if (data && data.success && data.topProcesses) {
  // Tomar las primeras 3 herramientas más usadas
  const topThree = data.topProcesses.slice(0, 3);
  if (topThree.length > 0) {
    featuredToolIds = topThree.map((p) => p.process_name);
  }
}

// Obtener todas las herramientas traducidas
const allTools = getTranslatedTools("all", lang);

// Filtrar solo las herramientas destacadas
const featuredTools = allTools.filter((tool) =>
  featuredToolIds.includes(tool.id)
);

// Mantener el orden de las herramientas más usadas
const displayTools = featuredToolIds
  .map((id) => featuredTools.find((tool) => tool.id === id))
  .filter((tool) => tool !== undefined)
  .slice(0, 3);
---

<section id="tools" class="select-none">
  <div class="mb-5">
    <h3 class="text-xl font-medium text-neutral-800 mb-2">{title}</h3>
    <p class="text-base text-neutral-600">{description}</p>
  </div>

  <div class="space-y-3">
    {
      displayTools.map((tool) => (
        <a
          href={`/${lang}${tool.href}`}
          class:list={[
            "flex flex-col sm:flex-row gap-4 group bg-white border border-neutral-200 rounded-xl p-5 hover:shadow-md hover:border-neutral-300 transition-all",
            !tool.isAvailable &&
              "opacity-50 cursor-not-allowed pointer-events-none",
          ]}
          title={tool.description}
        >
          <div class="relative w-full sm:w-20 h-20 flex-shrink-0 rounded-xl overflow-hidden bg-gradient-to-br from-neutral-800 to-neutral-900 p-3">
            <Picture
              src={ImageEditor}
              alt={tool.name}
              class="w-full h-full object-contain"
            />
            {tool.translatedBadge && (
              <span class="absolute top-2 right-2 bg-emerald-500 text-white text-xs px-2 py-0.5 rounded-full font-medium">
                {tool.translatedBadge}
              </span>
            )}
          </div>
          <div class="flex-1 flex flex-col justify-center min-w-0">
            <h4 class="text-base font-semibold text-neutral-800 mb-1.5 truncate">
              {tool.name}
            </h4>
            <p class="text-sm text-neutral-600 leading-relaxed line-clamp-2">
              {tool.description}
            </p>
          </div>
        </a>
      ))
    }
  </div>
</section>
